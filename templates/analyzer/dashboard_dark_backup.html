{% extends 'analyzer/layout.html' %}

{% block content %}
<!-- Ultra Modern Trading Dashboard -->
<style>
    /* New Modern Dashboard Styles */
    .dashboard-wrapper {
        background: #0f0f23;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #ffffff;
        overflow-x: hidden;
    }
    
    .top-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-bottom: 1px solid #2d3748;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .brand-area {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(45deg, #4ade80, #22c55e);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .brand-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #4ade80;
        letter-spacing: -0.025em;
    }
    
    .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .status-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(74, 222, 128, 0.1);
        border: 1px solid rgba(74, 222, 128, 0.3);
        border-radius: 20px;
        font-size: 0.875rem;
        color: #4ade80;
    }
    
    .live-dot {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .main-dashboard {
        padding: 1.5rem;
        display: grid;
        grid-template-columns: 300px 1fr 280px;
        gap: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .sidebar-left {
        background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
        border-radius: 16px;
        padding: 1.5rem;
        height: fit-content;
        border: 1px solid #475569;
    }
    
    .sidebar-right {
        background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
        border-radius: 16px;
        padding: 1.5rem;
        height: fit-content;
        border: 1px solid #475569;
    }
    
    .center-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .market-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .market-card {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 1px solid #475569;
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .market-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--accent-color);
    }
    
    .market-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent-color);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .market-card.nifty { --accent-color: #3b82f6; }
    .market-card.banknifty { --accent-color: #ef4444; }
    .market-card.sensex { --accent-color: #f59e0b; }
    
    .market-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .market-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .market-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-color);
        font-size: 0.875rem;
    }
    
    .market-price {
        font-size: 1.75rem;
        font-weight: 800;
        color: #ffffff;
        margin-bottom: 0.5rem;
        line-height: 1;
    }
    
    .market-change {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .change-up {
        color: #22c55e;
    }
    
    .change-down {
        color: #ef4444;
    }
    
    .change-neutral {
        color: #64748b;
    }
    
    .chart-container {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 1px solid #475569;
        border-radius: 16px;
        padding: 1.5rem;
        height: 400px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #ffffff;
    }
    
    .chart-tabs {
        display: flex;
        gap: 0.25rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 0.25rem;
    }
    
    .tab-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: #94a3b8;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tab-btn:hover {
        color: #ffffff;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .tab-btn.active {
        background: #4ade80;
        color: #000000;
    }
    
    .sidebar-title {
        font-size: 1rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .action-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .action-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: #e2e8f0;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .action-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #4ade80;
        color: #ffffff;
        transform: translateX(4px);
    }
    
    .action-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        background: var(--action-color, #4ade80);
        color: #000000;
    }
    
    .action-text {
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .portfolio-summary {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #475569;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }
    
    .summary-label {
        color: #94a3b8;
        font-size: 0.875rem;
    }
    
    .summary-value {
        color: #ffffff;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
        background-size: 200% 100%;
        animation: skeleton 1.5s infinite;
        border-radius: 4px;
        height: 1rem;
    }
    
    @keyframes skeleton {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    @media (max-width: 1200px) {
        .main-dashboard {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
        }
        
        .market-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .main-dashboard {
            padding: 1rem;
            gap: 1rem;
        }
        
        .market-grid {
            grid-template-columns: 1fr;
        }
        
        .top-header {
            padding: 1rem;
            flex-direction: column;
            gap: 1rem;
        }
    }
</style>

<div class="dashboard-wrapper">
    <!-- Header -->
    <header class="top-header">
        <div class="brand-area">
            <div class="logo-icon">📊</div>
            <div class="brand-title">FiFTO Pro</div>
        </div>
        
        <div class="header-controls">
            <div class="status-badge">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="status-badge">
                <span id="current-time">{{ current_time|date:"H:i:s" }}</span>
            </div>
            <button class="action-item" onclick="refreshAll()" style="margin: 0; padding: 0.5rem 1rem;">
                <div class="action-icon" style="width: 24px; height: 24px; font-size: 0.875rem;">🔄</div>
            </button>
        </div>
    </header>

    <!-- Main Dashboard -->
    <div class="main-dashboard">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <h3 class="sidebar-title">
                <span>🎯</span>
                Quick Actions
            </h3>
            <div class="action-list">
                <a href="/analysis/" class="action-item">
                    <div class="action-icon" style="--action-color: #3b82f6;">📈</div>
                    <div class="action-text">Options Analysis</div>
                </a>
                
                <a href="/option_chain/" class="action-item">
                    <div class="action-icon" style="--action-color: #8b5cf6;">🔗</div>
                    <div class="action-text">Option Chain</div>
                </a>
                
                <a href="/automation/" class="action-item">
                    <div class="action-icon" style="--action-color: #06b6d4;">⚡</div>
                    <div class="action-text">Automation</div>
                </a>
                
                <a href="/settings/" class="action-item">
                    <div class="action-icon" style="--action-color: #64748b;">⚙️</div>
                    <div class="action-text">Settings</div>
                </a>
            </div>
            
            <div class="portfolio-summary">
                <h4 class="sidebar-title" style="font-size: 0.875rem; margin-bottom: 0.75rem;">
                    <span>💼</span>
                    Portfolio
                </h4>
                <div class="summary-item">
                    <span class="summary-label">Active Trades</span>
                    <span class="summary-value">{{ active_trades_count|default:"0" }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">P&L Today</span>
                    <span class="summary-value" style="color: #22c55e;">+₹{{ today_pnl|default:"0" }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Success Rate</span>
                    <span class="summary-value">{{ success_rate|default:"0" }}%</span>
                </div>
            </div>
        </aside>

        <!-- Center Content -->
        <main class="center-content">
            <!-- Market Data Grid -->
            <div class="market-grid">
                <div class="market-card nifty">
                    <div class="market-header">
                        <div class="market-name">Nifty 50</div>
                        <div class="market-icon">📈</div>
                    </div>
                    <div class="market-price" id="nifty-price">
                        <div class="loading-skeleton"></div>
                    </div>
                    <div class="market-change" id="nifty-change">
                        <div class="loading-skeleton" style="width: 80px;"></div>
                    </div>
                </div>

                <div class="market-card banknifty">
                    <div class="market-header">
                        <div class="market-name">Bank Nifty</div>
                        <div class="market-icon">🏦</div>
                    </div>
                    <div class="market-price" id="banknifty-price">
                        <div class="loading-skeleton"></div>
                    </div>
                    <div class="market-change" id="banknifty-change">
                        <div class="loading-skeleton" style="width: 80px;"></div>
                    </div>
                </div>

                <div class="market-card sensex">
                    <div class="market-header">
                        <div class="market-name">Sensex</div>
                        <div class="market-icon">📊</div>
                    </div>
                    <div class="market-price" id="sensex-price">
                        <div class="loading-skeleton"></div>
                    </div>
                    <div class="market-change" id="sensex-change">
                        <div class="loading-skeleton" style="width: 80px;"></div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Market Trends</div>
                    <div class="chart-tabs">
                        <button class="tab-btn active" data-period="1d">1D</button>
                        <button class="tab-btn" data-period="1w">1W</button>
                        <button class="tab-btn" data-period="1m">1M</button>
                        <button class="tab-btn" data-period="3m">3M</button>
                    </div>
                </div>
                <div style="height: 320px; position: relative;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar-right">
            <h3 class="sidebar-title">
                <span>📊</span>
                Market Pulse
            </h3>
            
            <div class="action-list">
                <div class="action-item" style="cursor: default;">
                    <div class="action-icon" style="--action-color: #22c55e;">🎯</div>
                    <div>
                        <div class="action-text">Trend</div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">{{ market_trend|default:"Sideways" }}</div>
                    </div>
                </div>
                
                <div class="action-item" style="cursor: default;">
                    <div class="action-icon" style="--action-color: #f59e0b;">📈</div>
                    <div>
                        <div class="action-text">Volatility</div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">{{ volatility|default:"Medium" }}</div>
                    </div>
                </div>
                
                <div class="action-item" style="cursor: default;">
                    <div class="action-icon" style="--action-color: #8b5cf6;">⚖️</div>
                    <div>
                        <div class="action-text">PCR</div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">{{ pcr|default:"1.25" }}</div>
                    </div>
                </div>
            </div>
            
            <div class="portfolio-summary">
                <h4 class="sidebar-title" style="font-size: 0.875rem; margin-bottom: 0.75rem;">
                    <span>⏰</span>
                    Market Hours
                </h4>
                <div class="summary-item">
                    <span class="summary-label">Status</span>
                    <span class="summary-value" style="color: #4ade80;">{{ market_status|default:"Open" }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Next Close</span>
                    <span class="summary-value">15:30 IST</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Time to Close</span>
                    <span class="summary-value" id="time-to-close">--:--</span>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let mainChart = null;
let refreshInterval = null;

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Ultra Modern Dashboard Loading...');
    initializeChart();
    loadMarketData();
    updateClock();
    setupEventListeners();
    startAutoRefresh();
});

// Initialize main chart
function initializeChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'NIFTY 50',
                data: [],
                borderColor: '#4ade80',
                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 4,
                pointBackgroundColor: '#4ade80',
                pointBorderColor: '#000000',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        borderColor: 'rgba(255, 255, 255, 0.2)'
                    },
                    ticks: {
                        color: '#94a3b8',
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)',
                        borderColor: 'rgba(255, 255, 255, 0.2)'
                    },
                    ticks: {
                        color: '#94a3b8',
                        font: {
                            size: 11
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Load market data
async function loadMarketData() {
    console.log('📊 Loading market data...');
    
    try {
        const response = await fetch('/api/market-data/');
        const data = await response.json();
        
        if (data && typeof data === 'object') {
            updateMarketCards(data);
            await loadHistoricalData();
        }
    } catch (error) {
        console.error('❌ Error loading market data:', error);
        showLoadingError();
    }
}

// Update market cards with data
function updateMarketCards(data) {
    const markets = ['NIFTY', 'BANKNIFTY', 'SENSEX'];
    
    markets.forEach(market => {
        const marketData = data[market];
        if (marketData && marketData.current_price !== undefined) {
            const priceEl = document.getElementById(market.toLowerCase() + '-price');
            const changeEl = document.getElementById(market.toLowerCase() + '-change');
            
            if (priceEl && changeEl) {
                // Update price
                priceEl.textContent = new Intl.NumberFormat('en-IN').format(marketData.current_price);
                
                // Update change
                const change = marketData.change || 0;
                const changePercent = marketData.change_percent || 0;
                const isPositive = change >= 0;
                const changeClass = isPositive ? 'change-up' : 'change-down';
                const arrow = isPositive ? '↗' : '↘';
                
                changeEl.innerHTML = `<span class="${changeClass}">${arrow} ${Math.abs(change).toFixed(2)} (${Math.abs(changePercent).toFixed(2)}%)</span>`;
            }
        }
    });
}

// Load historical chart data
async function loadHistoricalData() {
    try {
        const response = await fetch('/api/historical-data/');
        const data = await response.json();
        
        if (data.NIFTY && Array.isArray(data.NIFTY)) {
            updateChart(data.NIFTY);
        }
    } catch (error) {
        console.error('❌ Error loading historical data:', error);
    }
}

// Update chart with new data
function updateChart(data) {
    if (!mainChart || !data || data.length === 0) return;
    
    const labels = data.map(item => {
        const date = new Date(item.Date);
        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
    }).slice(-20); // Last 20 data points
    
    const prices = data.map(item => parseFloat(item.Close)).slice(-20);
    
    mainChart.data.labels = labels;
    mainChart.data.datasets[0].data = prices;
    mainChart.update('none');
}

// Setup event listeners
function setupEventListeners() {
    // Chart period tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateChartPeriod(this.dataset.period);
        });
    });
}

// Update chart period
function updateChartPeriod(period) {
    console.log('📊 Updating chart period to:', period);
    loadHistoricalData();
}

// Refresh all data
async function refreshAll() {
    console.log('🔄 Refreshing all data...');
    
    // Show loading states
    document.querySelectorAll('.market-price').forEach(el => {
        el.innerHTML = '<div class="loading-skeleton"></div>';
    });
    document.querySelectorAll('.market-change').forEach(el => {
        el.innerHTML = '<div class="loading-skeleton" style="width: 80px;"></div>';
    });
    
    await loadMarketData();
}

// Show loading error
function showLoadingError() {
    document.querySelectorAll('.market-price').forEach(el => {
        el.innerHTML = '<span style="color: #ef4444;">Error</span>';
    });
}

// Update clock
function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-IN', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    const clockEl = document.getElementById('current-time');
    if (clockEl) {
        clockEl.textContent = timeString;
    }
    
    // Update time to close
    updateTimeToClose();
}

// Update time to market close
function updateTimeToClose() {
    const now = new Date();
    const closeTime = new Date();
    closeTime.setHours(15, 30, 0, 0);
    
    if (now > closeTime) {
        closeTime.setDate(closeTime.getDate() + 1);
    }
    
    const diff = closeTime - now;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    const timeToCloseEl = document.getElementById('time-to-close');
    if (timeToCloseEl) {
        timeToCloseEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }
}

// Start auto refresh
function startAutoRefresh() {
    // Update clock every second
    setInterval(updateClock, 1000);
    
    // Refresh data every 2 minutes
    refreshInterval = setInterval(refreshAll, 120000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

console.log('✅ Ultra Modern Dashboard Ready!');
</script>
{% endblock %}
