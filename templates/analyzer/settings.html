{% extends "analyzer/layout.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<!-- Dashboard Style Header -->
<div class="dashboard-header modern">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="header-content">
                    <h1 class="dashboard-title">
                        <i class="bi bi-gear-fill me-3"></i>
                        Application Settings
                    </h1>
                    <p class="dashboard-subtitle">Configure your trading preferences and system behavior</p>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="status-badge-container">
                    <span class="status-badge status-active">
                        <i class="bi bi-check-circle me-2"></i>
                        System Active
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Main Settings Card with Tabs -->
        <div class="card clean-card border-0 shadow-sm mb-4">
            <div class="card-header bg-light border-bottom">
                <div class="d-flex align-items-center">
                    <i class="bi bi-sliders text-primary me-3 fs-5"></i>
                    <div>
                        <h5 class="mb-0 fw-bold">Configuration Panel</h5>
                        <p class="text-muted mb-0 small">Customize your trading experience</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Navigation Tabs -->
            <div class="card-body p-0">
                <nav class="settings-tabs">
                    <div class="nav nav-tabs border-0" id="settingsTabs" role="tablist">
                        <button class="nav-link active" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-config" type="button" role="tab">
                            <i class="bi bi-telegram me-2"></i>Telegram Config
                        </button>
                        <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-config" type="button" role="tab">
                            <i class="bi bi-bell me-2"></i>Alert Settings
                        </button>
                        <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading-config" type="button" role="tab">
                            <i class="bi bi-graph-up me-2"></i>Trading Config
                        </button>
                        <button class="nav-link" id="refresh-tab" data-bs-toggle="tab" data-bs-target="#refresh-config" type="button" role="tab">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh Settings
                        </button>
                    </div>
                </nav>
                
                <form method="POST" action="{% url 'settings' %}" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="tab-content" id="settingsTabsContent">
                        <!-- Telegram Configuration -->
                        <div class="tab-pane fade show active" id="telegram-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-telegram text-info me-2"></i>
                                                Telegram Bot Configuration
                                            </h6>
                                            <p class="setting-description">Configure your Telegram bot for automated notifications</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="bot_token" class="form-label fw-bold">Bot Token</label>
                                                    <input type="text" class="form-control" name="bot_token" id="bot_token" 
                                                           value="{{ settings.bot_token|default:'' }}" 
                                                           placeholder="Enter your Telegram bot token">
                                                    <small class="text-muted">Get this from @BotFather on Telegram</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="chat_id" class="form-label fw-bold">Chat ID</label>
                                                    <input type="text" class="form-control" name="chat_id" id="chat_id" 
                                                           value="{{ settings.chat_id|default:'' }}" 
                                                           placeholder="Enter your chat ID">
                                                    <small class="text-muted">Your Telegram chat ID for notifications</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alert Settings -->
                        <div class="tab-pane fade" id="alerts-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-bell-fill text-warning me-2"></i>
                                                Alert Preferences
                                            </h6>
                                            <p class="setting-description">Choose which alerts you want to receive</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_target_alerts" id="enable_target_alerts"
                                                               {% if settings.enable_target_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_target_alerts">
                                                            <strong>Target Hit Alerts</strong>
                                                            <br><small class="text-muted">Get notified when targets are reached</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_stoploss_alerts" id="enable_stoploss_alerts"
                                                               {% if settings.enable_stoploss_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_stoploss_alerts">
                                                            <strong>Stop Loss Alerts</strong>
                                                            <br><small class="text-muted">Get notified when stop loss is triggered</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_trade_alerts" id="enable_trade_alerts"
                                                               {% if settings.enable_trade_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_trade_alerts">
                                                            <strong>Trade Entry Alerts</strong>
                                                            <br><small class="text-muted">Get notified when new trades are added</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_summary_alerts" id="enable_summary_alerts"
                                                               {% if settings.enable_summary_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_summary_alerts">
                                                            <strong>Daily Summary</strong>
                                                            <br><small class="text-muted">Get end-of-day summary reports</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trading Configuration -->
                        <div class="tab-pane fade" id="trading-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-graph-up text-success me-2"></i>
                                                Trading Configuration
                                            </h6>
                                            <p class="setting-description">Configure lot sizes and trading parameters</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="nifty_lot_size" class="form-label fw-bold">NIFTY Lot Size</label>
                                                    <input type="number" class="form-control" name="nifty_lot_size" id="nifty_lot_size" 
                                                           value="{{ settings.nifty_lot_size|default:25 }}" min="1" max="1000">
                                                    <small class="text-muted">Number of lots for NIFTY trades</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="banknifty_lot_size" class="form-label fw-bold">BANKNIFTY Lot Size</label>
                                                    <input type="number" class="form-control" name="banknifty_lot_size" id="banknifty_lot_size" 
                                                           value="{{ settings.banknifty_lot_size|default:15 }}" min="1" max="1000">
                                                    <small class="text-muted">Number of lots for BANKNIFTY trades</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="auto_close_targets" id="auto_close_targets"
                                                               {% if settings.auto_close_targets %}checked{% endif %}>
                                                        <label class="form-check-label" for="auto_close_targets">
                                                            <strong>Auto Close on Target</strong>
                                                            <br><small class="text-muted">Automatically close trades when target is hit</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="auto_close_stoploss" id="auto_close_stoploss"
                                                               {% if settings.auto_close_stoploss %}checked{% endif %}>
                                                        <label class="form-check-label" for="auto_close_stoploss">
                                                            <strong>Auto Close on Stop Loss</strong>
                                                            <br><small class="text-muted">Automatically close trades when stop loss is hit</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refresh Settings -->
                        <div class="tab-pane fade" id="refresh-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-arrow-clockwise text-primary me-2"></i>
                                                Refresh & Update Settings
                                            </h6>
                                            <p class="setting-description">Configure how often data is updated</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="interval" class="form-label fw-bold">Update Interval</label>
                                                    <select class="form-select" name="interval" id="interval">
                                                        {% for choice in choices %}
                                                        <option value="{{ choice }}" {% if settings.interval == choice %}selected{% endif %}>
                                                            {{ choice }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                    <small class="text-muted">How often to check for updates</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="pnl_refresh_interval" class="form-label fw-bold">P&L Refresh</label>
                                                    <select class="form-select" name="pnl_refresh_interval" id="pnl_refresh_interval">
                                                        <option value="1min" {% if settings.pnl_refresh_interval == '1min' %}selected{% endif %}>1 Minute</option>
                                                        <option value="5min" {% if settings.pnl_refresh_interval == '5min' %}selected{% endif %}>5 Minutes</option>
                                                        <option value="10min" {% if settings.pnl_refresh_interval == '10min' %}selected{% endif %}>10 Minutes</option>
                                                        <option value="15min" {% if settings.pnl_refresh_interval == '15min' %}selected{% endif %}>15 Minutes</option>
                                                    </select>
                                                    <small class="text-muted">P&L update frequency</small>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_eod_summary" id="enable_eod_summary"
                                                               {% if settings.enable_eod_summary %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_eod_summary">
                                                            <strong>Enable End-of-Day Summary</strong>
                                                            <br><small class="text-muted">Generate daily trading summary reports</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="p-4 border-top bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="bi bi-info-circle me-1"></i>
                                Changes will be applied immediately after saving
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="bi bi-check-circle me-2"></i>
                                Save All Settings
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern unified dashboard header style */
.dashboard-header.modern {background:linear-gradient(140deg,#f0fdf4 0%,#dcfce7 55%,#d1fae5 100%);border:1px solid #bbf7d0;border-radius:22px;padding:1.8rem 2.2rem;margin-bottom:2.2rem;box-shadow:0 6px 18px -6px rgba(16,185,129,.25),0 2px 4px rgba(0,0,0,.04);position:relative;overflow:hidden;}
.dashboard-header.modern:before {content:"";position:absolute;inset:0;background:radial-gradient(circle at 85% 15%,rgba(16,185,129,.15),transparent 60%);pointer-events:none;}
.dashboard-title i {color:#059669;font-size:1.9rem;}
/* Dashboard Header Styling */
.dashboard-header {
    background: linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);
    border-bottom:1px solid #bbf7d0;
    padding:2rem 0;
    margin-bottom:2rem;
    box-shadow:0 1px 3px rgba(0,0,0,.06);
}

.header-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
}

.dashboard-title i {
    color: #3b82f6;
    font-size: 1.75rem;
}

.dashboard-subtitle {
    color: #6b7280;
    font-size: 1rem;
    margin: 0;
    font-weight: 400;
}

.status-badge-container {
    display: flex;
    justify-content: flex-end;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    transition: all 0.2s ease;
}

.status-active {
    background-color: #10b981;
    color: white;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.39);
}

.status-inactive {
    background-color: #6b7280;
    color: white;
    box-shadow: 0 4px 14px rgba(107, 114, 128, 0.39);
}

.status-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* Settings specific styling */
.settings-header {
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #e3e8f0;
}

.clean-card {
    border-radius: 12px;
    overflow: hidden;
}

.settings-tabs .nav-tabs {
    background: #f8f9fa;
    padding: 1rem 1rem 0;
}

.settings-tabs .nav-link {
    border: none;
    border-radius: 8px 8px 0 0;
    color: #6c757d;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    margin-right: 0.5rem;
    transition: all 0.3s ease;
}

.settings-tabs .nav-link:hover {
    background: rgba(108, 117, 125, 0.1);
    color: #495057;
}

.settings-tabs .nav-link.active {
    background: white;
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
}

.setting-group {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
}

.setting-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.setting-description {
    color: #6c757d;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
}

.form-check-label strong {
    color: #212529;
    font-weight: 600;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    const triggerTabList = document.querySelectorAll('#settingsTabs button[data-bs-toggle="tab"]');
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // Form validation
    const form = document.querySelector('.settings-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const botToken = document.getElementById('bot_token').value;
            const chatId = document.getElementById('chat_id').value;
            
            if (botToken && !chatId) {
                e.preventDefault();
                alert('Please provide Chat ID when Bot Token is specified.');
                return false;
            }
            
            if (chatId && !botToken) {
                e.preventDefault();
                alert('Please provide Bot Token when Chat ID is specified.');
                return false;
            }
        });
    }
});
</script>
{% endblock %}
