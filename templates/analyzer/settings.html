{% extends "analyzer/layout.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<!-- Uniform Page Header -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-lg-8">
            <h1 class="page-title">
                <i class="bi bi-gear text-secondary"></i>
                Application Settings
            </h1>
            <p class="page-subtitle">Configure your trading preferences, system behavior, and notifications</p>
            <div class="page-stats">
                <span class="stat-badge primary">
                    <i class="bi bi-check-circle"></i>
                    System Active
                </span>
                <span class="stat-badge success">
                    <i class="bi bi-shield-check"></i>
                    Secure Configuration
                </span>
                <span class="stat-badge warning">
                    <i class="bi bi-bell"></i>
                    Alerts Enabled
                </span>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="page-actions">
                <button type="button" class="btn btn-light-success me-2" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh Settings
                </button>
                <button type="button" class="btn btn-light-primary" onclick="testConfiguration()">
                    <i class="bi bi-play-circle"></i>
                    Test Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Main Settings Card with Tabs -->
        <div class="card clean-card border-0 shadow-sm mb-4">
            <div class="card-header bg-light border-bottom">
                <div class="d-flex align-items-center">
                    <i class="bi bi-sliders text-primary me-3 fs-5"></i>
                    <div>
                        <h5 class="mb-0 fw-bold">Configuration Panel</h5>
                        <p class="text-muted mb-0 small">Customize your trading experience</p>
                    </div>
                </div>
            </div>
            
            <!-- Settings Navigation Tabs -->
            <div class="card-body p-0">
                <nav class="settings-tabs">
                    <div class="nav nav-tabs border-0" id="settingsTabs" role="tablist">
                        <button class="nav-link active" id="telegram-tab" data-bs-toggle="tab" data-bs-target="#telegram-config" type="button" role="tab">
                            <i class="bi bi-telegram me-2"></i>Telegram Config
                        </button>
                        <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-config" type="button" role="tab">
                            <i class="bi bi-bell me-2"></i>Alert Settings
                        </button>
                        <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading-config" type="button" role="tab">
                            <i class="bi bi-graph-up me-2"></i>Trading Config
                        </button>
                        <!-- Refresh Settings Tab Removed - On-demand mode only -->
                    </div>
                </nav>
                
                <form method="POST" action="{% url 'settings' %}" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="tab-content" id="settingsTabsContent">
                        <!-- Telegram Configuration -->
                        <div class="tab-pane fade show active" id="telegram-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-telegram text-info me-2"></i>
                                                Telegram Bot Configuration
                                            </h6>
                                            <p class="setting-description">Configure your Telegram bot for automated notifications</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="bot_token" class="form-label fw-bold">Bot Token</label>
                                                    <input type="text" class="form-control" name="bot_token" id="bot_token" 
                                                           value="{{ settings.bot_token|default:'' }}" 
                                                           placeholder="Enter your Telegram bot token">
                                                    <small class="text-muted">Get this from @BotFather on Telegram</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="chat_id" class="form-label fw-bold">Chat ID</label>
                                                    <input type="text" class="form-control" name="chat_id" id="chat_id" 
                                                           value="{{ settings.chat_id|default:'' }}" 
                                                           placeholder="Enter your chat ID">
                                                    <small class="text-muted">Your Telegram chat ID for notifications</small>
                                                </div>
                                                <div class="col-12">
                                                    <div class="alert alert-info border-0 rounded-3">
                                                        <div class="d-flex align-items-center">
                                                            <i class="bi bi-info-circle me-2"></i>
                                                            <span class="flex-grow-1">Test your Telegram configuration to ensure notifications work properly</span>
                                                            <button type="button" id="testTelegramBtn" class="btn btn-info btn-sm ms-3">
                                                                <i class="bi bi-send me-2"></i>Send Test Message
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alert Settings -->
                        <div class="tab-pane fade" id="alerts-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-bell-fill text-warning me-2"></i>
                                                Alert Preferences
                                            </h6>
                                            <p class="setting-description">Choose which alerts you want to receive</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_target_alerts" id="enable_target_alerts"
                                                               {% if settings.enable_target_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_target_alerts">
                                                            <strong>Target Hit Alerts</strong>
                                                            <br><small class="text-muted">Get notified when targets are reached</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_stoploss_alerts" id="enable_stoploss_alerts"
                                                               {% if settings.enable_stoploss_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_stoploss_alerts">
                                                            <strong>Stop Loss Alerts</strong>
                                                            <br><small class="text-muted">Get notified when stop loss is triggered</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_trade_alerts" id="enable_trade_alerts"
                                                               {% if settings.enable_trade_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_trade_alerts">
                                                            <strong>Trade Entry Alerts</strong>
                                                            <br><small class="text-muted">Get notified when new trades are added</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="enable_summary_alerts" id="enable_summary_alerts"
                                                               {% if settings.enable_summary_alerts %}checked{% endif %}>
                                                        <label class="form-check-label" for="enable_summary_alerts">
                                                            <strong>Daily Summary</strong>
                                                            <br><small class="text-muted">Get end-of-day summary reports</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trading Configuration -->
                        <div class="tab-pane fade" id="trading-config" role="tabpanel">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="setting-group">
                                            <h6 class="setting-title">
                                                <i class="bi bi-graph-up text-success me-2"></i>
                                                Trading Configuration
                                            </h6>
                                            <p class="setting-description">Configure lot sizes and trading parameters</p>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="nifty_lot_size" class="form-label fw-bold">NIFTY Lot Size</label>
                                                    <input type="number" class="form-control" name="nifty_lot_size" id="nifty_lot_size" 
                                                           value="{{ settings.nifty_lot_size|default:25 }}" min="1" max="1000">
                                                    <small class="text-muted">Number of lots for NIFTY trades</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="banknifty_lot_size" class="form-label fw-bold">BANKNIFTY Lot Size</label>
                                                    <input type="number" class="form-control" name="banknifty_lot_size" id="banknifty_lot_size" 
                                                           value="{{ settings.banknifty_lot_size|default:15 }}" min="1" max="1000">
                                                    <small class="text-muted">Number of lots for BANKNIFTY trades</small>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="auto_close_targets" id="auto_close_targets"
                                                               {% if settings.auto_close_targets %}checked{% endif %}>
                                                        <label class="form-check-label" for="auto_close_targets">
                                                            <strong>Auto Close on Target</strong>
                                                            <br><small class="text-muted">Automatically close trades when target is hit</small>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="auto_close_stoploss" id="auto_close_stoploss"
                                                               {% if settings.auto_close_stoploss %}checked{% endif %}>
                                                        <label class="form-check-label" for="auto_close_stoploss">
                                                            <strong>Auto Close on Stop Loss</strong>
                                                            <br><small class="text-muted">Automatically close trades when stop loss is hit</small>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Manual Refresh Controls -->
                                            <div class="row g-3 mt-3">
                                                <div class="col-12">
                                                    <h6 class="mb-3">
                                                        <i class="bi bi-arrow-clockwise text-info me-2"></i>
                                                        Manual Data Refresh (On-Demand)
                                                    </h6>
                                                    <div class="row g-2">
                                                        <div class="col-md-3">
                                                            <button type="submit" name="refresh_trades" class="btn btn-outline-primary btn-sm w-100">
                                                                <i class="bi bi-list-ul me-1"></i>Refresh Trades
                                                            </button>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <button type="submit" name="refresh_pnl" class="btn btn-outline-success btn-sm w-100">
                                                                <i class="bi bi-graph-up me-1"></i>Refresh P&L
                                                            </button>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <button type="submit" name="refresh_option_chain" class="btn btn-outline-info btn-sm w-100">
                                                                <i class="bi bi-grid me-1"></i>Refresh Options
                                                            </button>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <button type="submit" name="clear_cache" class="btn btn-outline-warning btn-sm w-100">
                                                                <i class="bi bi-trash me-1"></i>Clear Cache
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted mt-2 d-block">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        Use these buttons to manually refresh data when needed instead of automatic background updates
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refresh Settings Tab Removed - On-demand mode only -->
                    </div>
                    
                    <!-- Save Button -->
                    <div class="p-4 border-top bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                <i class="bi bi-info-circle me-1"></i>
                                Changes will be applied immediately after saving
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="bi bi-check-circle me-2"></i>
                                Save All Settings
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Dashboard Header Styling */
.dashboard-header {
    background: linear-gradient(135deg, #f8fafb 0%, #ffffff 100%);
    border-bottom: 1px solid #e5e7eb;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.header-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.dashboard-title {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
}

.dashboard-title i {
    color: #3b82f6;
    font-size: 1.75rem;
}

.dashboard-subtitle {
    color: #6b7280;
    font-size: 1rem;
    margin: 0;
    font-weight: 400;
}

.status-badge-container {
    display: flex;
    justify-content: flex-end;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    transition: all 0.2s ease;
}

.status-active {
    background-color: #10b981;
    color: white;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.39);
}

.status-inactive {
    background-color: #6b7280;
    color: white;
    box-shadow: 0 4px 14px rgba(107, 114, 128, 0.39);
}

.status-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

/* Settings specific styling */
.settings-header {
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #e3e8f0;
}

.clean-card {
    border-radius: 12px;
    overflow: hidden;
}

.settings-tabs .nav-tabs {
    background: #f8f9fa;
    padding: 1rem 1rem 0;
}

.settings-tabs .nav-link {
    border: none;
    border-radius: 8px 8px 0 0;
    color: #6c757d;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    margin-right: 0.5rem;
    transition: all 0.3s ease;
}

.settings-tabs .nav-link:hover {
    background: rgba(108, 117, 125, 0.1);
    color: #495057;
}

.settings-tabs .nav-link.active {
    background: white;
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
}

.setting-group {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
}

.setting-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.setting-description {
    color: #6c757d;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
}

.form-check-label strong {
    color: #212529;
    font-weight: 600;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    const triggerTabList = document.querySelectorAll('#settingsTabs button[data-bs-toggle="tab"]');
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // Form validation
    const form = document.querySelector('.settings-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const botToken = document.getElementById('bot_token').value;
            const chatId = document.getElementById('chat_id').value;
            
            if (botToken && !chatId) {
                e.preventDefault();
                alert('Please provide Chat ID when Bot Token is specified.');
                return false;
            }
            
            if (chatId && !botToken) {
                e.preventDefault();
                alert('Please provide Bot Token when Chat ID is specified.');
                return false;
            }
        });
    }
    
    // Test Telegram functionality
    const testTelegramBtn = document.getElementById('testTelegramBtn');
    if (testTelegramBtn) {
        testTelegramBtn.addEventListener('click', function() {
            const botToken = document.getElementById('bot_token').value;
            const chatId = document.getElementById('chat_id').value;
            
            if (!botToken || !chatId) {
                alert('Please enter both Bot Token and Chat ID before testing.');
                return;
            }
            
            // Change button state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
            this.disabled = true;
            
            // Send test message
            fetch('/test_telegram/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    'bot_token': botToken,
                    'chat_id': chatId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Test message sent successfully! Check your Telegram.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    this.parentElement.parentElement.appendChild(alertDiv);
                    
                    // Auto dismiss after 5 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                } else {
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to send test message: ${data.error || 'Unknown error'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    this.parentElement.parentElement.appendChild(alertDiv);
                    
                    // Auto dismiss after 8 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 8000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Network error occurred. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                this.parentElement.parentElement.appendChild(alertDiv);
            })
            .finally(() => {
                // Restore button state
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    }
    
    // Real-time Dashboard Refresh Controls
    const refreshControls = {
        '10sec': document.getElementById('refresh-10sec'),
        '30sec': document.getElementById('refresh-30sec'),
        '1min': document.getElementById('refresh-1min'),
        'stop': document.getElementById('refresh-stop')
    };
    
    // Apply refresh rate function
    function applyRefreshRate(interval) {
        // Update the dashboard refresh interval dropdown
        const dashboardSelect = document.getElementById('dashboard_refresh_interval');
        if (dashboardSelect && interval !== 'stop') {
            dashboardSelect.value = interval;
        }
        
        // Store in localStorage for immediate effect
        localStorage.setItem('dashboard_refresh_rate', interval);
        
        // Send to server to save permanently
        fetch('/update_refresh_rate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                'refresh_rate': interval
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to save refresh rate:', data.error);
            }
        })
        .catch(error => {
            console.error('Error saving refresh rate:', error);
        });
        
        // Visual feedback
        Object.values(refreshControls).forEach(btn => {
            if (btn) btn.classList.remove('btn-warning');
        });
        
        if (refreshControls[interval]) {
            refreshControls[interval].classList.add('btn-warning');
        }
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        
        const intervalText = {
            '10sec': '⚡ 10 Seconds - Real-time updates active',
            '30sec': '🔄 30 Seconds - Balanced refresh rate',
            '1min': '🕐 1 Minute - Conservative refresh rate',
            'stop': '⏸️ Refresh stopped - Manual refresh only'
        };
        
        notification.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>
            <strong>Refresh Rate Updated:</strong><br>
            ${intervalText[interval] || 'Custom rate applied'}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove notification
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 4000);
        
        // Trigger immediate dashboard refresh if not stopped
        if (interval !== 'stop' && window.location.pathname.includes('dashboard')) {
            setTimeout(() => {
                window.location.reload();
            }, 500);
        }
    }
    
    // Add event listeners to refresh control buttons
    Object.entries(refreshControls).forEach(([interval, button]) => {
        if (button) {
            button.addEventListener('click', () => applyRefreshRate(interval));
        }
    });
    
    // Load saved refresh rate on page load
    const savedRate = localStorage.getItem('dashboard_refresh_rate');
    if (savedRate && refreshControls[savedRate]) {
        refreshControls[savedRate].classList.add('btn-warning');
    }
});
</script>

<style>
/* Card hover effect */
.card.bg-light:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    transition: all 0.3s ease;
}
</style>

{% endblock %}
