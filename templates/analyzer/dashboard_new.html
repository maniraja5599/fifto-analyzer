{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fifto Analyzer - Market Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            padding-top: 120px; /* Space for fixed header */
        }

        /* Fixed Market Header */
        .market-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 1rem 0;
        }

        .market-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .market-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid var(--accent-color);
            position: relative;
        }

        .market-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .market-item.clickable:hover::after {
            content: 'Click for Option Chain';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1001;
        }

        .market-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .market-symbol {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .market-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-color);
            color: white;
            font-size: 0.75rem;
        }

        .market-price {
            font-size: 1.2rem;
            font-weight: 800;
            color: #1e293b;
        }

        .market-change {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .change-up { color: #059669; }
        .change-down { color: #dc2626; }
        .change-neutral { color: #6b7280; }

        /* Market specific colors */
        .nifty { --accent-color: #3b82f6; }
        .banknifty { --accent-color: #8b5cf6; }
        .sensex { --accent-color: #f59e0b; }
        .vix { --accent-color: #ef4444; }

        /* Main Content Area */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .welcome-section {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .welcome-section h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-section p {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }

        /* Option Chain Modal */
        .option-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .option-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 1200px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .option-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .option-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .option-table th,
        .option-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .option-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .call-option {
            background: rgba(34, 197, 94, 0.1);
        }

        .put-option {
            background: rgba(239, 68, 68, 0.1);
        }

        .atm-strike {
            background: rgba(59, 130, 246, 0.2);
            font-weight: 700;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Demo content for scrolling */
        .demo-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .demo-section h2 {
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .demo-section p {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .market-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0 1rem;
            }

            .market-item {
                padding: 0.75rem;
            }

            .market-symbol {
                font-size: 0.875rem;
            }

            .market-price {
                font-size: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .welcome-section h1 {
                font-size: 2rem;
            }

            body {
                padding-top: 140px;
            }
        }

        @media (max-width: 480px) {
            .market-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Market Header -->
    <header class="market-header">
        <div class="market-container">
            <!-- NIFTY -->
            <div class="market-item nifty clickable" onclick="openOptionChain('NIFTY')">
                <div class="market-header-row">
                    <div class="market-symbol">
                        <div class="market-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        NIFTY
                    </div>
                    <div class="market-price" id="nifty-price">Loading...</div>
                </div>
                <div class="market-change" id="nifty-change">
                    <span>Loading...</span>
                </div>
            </div>

            <!-- BANKNIFTY -->
            <div class="market-item banknifty clickable" onclick="openOptionChain('BANKNIFTY')">
                <div class="market-header-row">
                    <div class="market-symbol">
                        <div class="market-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        BANKNIFTY
                    </div>
                    <div class="market-price" id="banknifty-price">Loading...</div>
                </div>
                <div class="market-change" id="banknifty-change">
                    <span>Loading...</span>
                </div>
            </div>

            <!-- SENSEX -->
            <div class="market-item sensex">
                <div class="market-header-row">
                    <div class="market-symbol">
                        <div class="market-icon">
                            <i class="fas fa-chart-area"></i>
                        </div>
                        SENSEX
                    </div>
                    <div class="market-price" id="sensex-price">Loading...</div>
                </div>
                <div class="market-change" id="sensex-change">
                    <span>Loading...</span>
                </div>
            </div>

            <!-- VIX -->
            <div class="market-item vix">
                <div class="market-header-row">
                    <div class="market-symbol">
                        <div class="market-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        VIX
                    </div>
                    <div class="market-price" id="vix-price">Loading...</div>
                </div>
                <div class="market-change" id="vix-change">
                    <span>Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="welcome-section">
            <h1><i class="fas fa-chart-line"></i> Fifto Analyzer</h1>
            <p>Live Market Data & Option Chain Analysis</p>
            <p><strong>Click on NIFTY or BANKNIFTY</strong> in the header above to view their option chains</p>
        </div>

        <!-- Demo sections for scrolling -->
        <div class="demo-section">
            <h2>Market Analysis</h2>
            <p>This is a demo section to show the fixed header functionality. The market data header will stay fixed at the top as you scroll through this content.</p>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
        </div>

        <div class="demo-section">
            <h2>Trading Insights</h2>
            <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
        </div>

        <div class="demo-section">
            <h2>Portfolio Management</h2>
            <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
            <p>Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem.</p>
        </div>

        <div class="demo-section">
            <h2>Risk Analysis</h2>
            <p>Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur?</p>
            <p>Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?</p>
        </div>

        <!-- More demo content to enable scrolling -->
        <div class="demo-section">
            <h2>Technical Analysis</h2>
            <p>At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium voluptatum deleniti atque corrupti quos dolores et quas molestias excepturi sint occaecati cupiditate non provident.</p>
        </div>

        <div class="demo-section">
            <h2>Market Trends</h2>
            <p>Similique sunt in culpa qui officia deserunt mollitia animi, id est laborum et dolorum fuga. Et harum quidem rerum facilis est et expedita distinctio.</p>
        </div>
    </main>

    <!-- Option Chain Modal -->
    <div class="option-modal" id="optionModal">
        <div class="option-content">
            <div class="option-header">
                <div class="option-title" id="optionTitle">Option Chain</div>
                <button class="close-btn" onclick="closeOptionChain()">×</button>
            </div>
            <div class="loading" id="optionLoading">
                <div class="spinner"></div>
                <p>Loading Option Chain...</p>
            </div>
            <div id="optionTableContainer" style="display: none;">
                <!-- Option chain table will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Market Header...');
            loadMarketData();
            
            // Auto-refresh disabled - Use manual refresh only
            // Original auto-refresh code disabled:
            // setInterval(loadMarketData, 60000);
            console.log('🛑 Dashboard auto-refresh disabled - Use manual refresh button instead');
        });

        // Load market data
        async function loadMarketData() {
            console.log('📊 Loading market data...');
            
            try {
                const response = await fetch('/api/market-data/');
                const data = await response.json();
                
                if (data && data.success && data.market_data) {
                    updateMarketHeader(data.market_data);
                } else {
                    console.error('❌ Invalid data structure:', data);
                    showLoadingError();
                }
            } catch (error) {
                console.error('❌ Error loading market data:', error);
                showLoadingError();
            }
        }

        // Update market header with data
        function updateMarketHeader(marketData) {
            const markets = [
                { key: 'NIFTY', id: 'nifty' },
                { key: 'BANKNIFTY', id: 'banknifty' },
                { key: 'SENSEX', id: 'sensex' },
                { key: 'VIX', id: 'vix' }
            ];
            
            markets.forEach(market => {
                const marketInfo = marketData[market.key];
                if (marketInfo && marketInfo.current_price !== undefined) {
                    const priceEl = document.getElementById(market.id + '-price');
                    const changeEl = document.getElementById(market.id + '-change');
                    
                    if (priceEl && changeEl) {
                        // Update price
                        const price = parseFloat(marketInfo.current_price) || 0;
                        priceEl.textContent = '₹' + new Intl.NumberFormat('en-IN').format(price);
                        
                        // Update change
                        const change = parseFloat(marketInfo.change) || 0;
                        const changePercent = parseFloat(marketInfo.change_percent) || 0;
                        const isPositive = change >= 0;
                        const changeClass = isPositive ? 'change-up' : (change < 0 ? 'change-down' : 'change-neutral');
                        const arrow = isPositive ? '↗' : (change < 0 ? '↘' : '→');
                        
                        changeEl.className = 'market-change ' + changeClass;
                        changeEl.innerHTML = `
                            <span>${arrow} ₹${Math.abs(change).toFixed(2)} (${changePercent.toFixed(2)}%)</span>
                        `;
                        
                        console.log(`✅ Updated ${market.key}: ₹${price} (${changePercent.toFixed(2)}%)`);
                    }
                } else {
                    console.warn(`⚠️ No data for ${market.key}`);
                }
            });
        }

        // Show loading error
        function showLoadingError() {
            const markets = ['nifty', 'banknifty', 'sensex', 'vix'];
            markets.forEach(market => {
                const priceEl = document.getElementById(market + '-price');
                const changeEl = document.getElementById(market + '-change');
                if (priceEl) priceEl.textContent = 'Error';
                if (changeEl) changeEl.innerHTML = '<span>Refresh needed</span>';
            });
        }

        // Open option chain modal
        function openOptionChain(symbol) {
            console.log('📈 Opening option chain for:', symbol);
            
            const modal = document.getElementById('optionModal');
            const title = document.getElementById('optionTitle');
            const loading = document.getElementById('optionLoading');
            const tableContainer = document.getElementById('optionTableContainer');
            
            title.textContent = `${symbol} Option Chain`;
            modal.classList.add('show');
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
            
            // Simulate loading option chain data
            setTimeout(() => {
                loadOptionChainData(symbol);
            }, 1500);
        }

        // Close option chain modal
        function closeOptionChain() {
            const modal = document.getElementById('optionModal');
            modal.classList.remove('show');
        }

        // Load option chain data (simulated)
        function loadOptionChainData(symbol) {
            const loading = document.getElementById('optionLoading');
            const tableContainer = document.getElementById('optionTableContainer');
            
            // Get current price for ATM calculation
            const priceEl = document.getElementById(symbol.toLowerCase() + '-price');
            const currentPriceText = priceEl.textContent.replace('₹', '').replace(/,/g, '');
            const currentPrice = parseFloat(currentPriceText) || (symbol === 'NIFTY' ? 24600 : 51400);
            
            // Generate option chain strikes
            const baseStrike = Math.round(currentPrice / 50) * 50; // Round to nearest 50
            const strikes = [];
            
            for (let i = -10; i <= 10; i++) {
                const strike = baseStrike + (i * 50);
                const isATM = Math.abs(strike - currentPrice) < 25;
                
                strikes.push({
                    strike: strike,
                    isATM: isATM,
                    callLTP: (Math.random() * 200 + 10).toFixed(2),
                    callOI: Math.floor(Math.random() * 100000),
                    putLTP: (Math.random() * 200 + 10).toFixed(2),
                    putOI: Math.floor(Math.random() * 100000)
                });
            }
            
            // Generate table HTML
            let tableHTML = `
                <table class="option-table">
                    <thead>
                        <tr>
                            <th class="call-option">Call OI</th>
                            <th class="call-option">Call LTP</th>
                            <th>Strike</th>
                            <th class="put-option">Put LTP</th>
                            <th class="put-option">Put OI</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            strikes.forEach(option => {
                const rowClass = option.isATM ? 'atm-strike' : '';
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="call-option">${option.callOI.toLocaleString()}</td>
                        <td class="call-option">₹${option.callLTP}</td>
                        <td><strong>${option.strike}</strong></td>
                        <td class="put-option">₹${option.putLTP}</td>
                        <td class="put-option">${option.putOI.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            // Display the table
            loading.style.display = 'none';
            tableContainer.innerHTML = tableHTML;
            tableContainer.style.display = 'block';
            
            console.log(`✅ Option chain loaded for ${symbol}`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('optionModal');
            if (event.target === modal) {
                closeOptionChain();
            }
        }
    </script>
</body>
</html>
