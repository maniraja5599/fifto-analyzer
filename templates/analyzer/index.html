{% extends "analyzer/layout.html" %}
{% block content %}

<div class="row">
    <div class="col-12">
        <!-- Simple Analysis Form -->
        <div class="card border border-light bg-light mb-3">
            <div class="card-header bg-white border-light">
                <h5 class="mb-0">Generate Analysis</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{% url 'generate_analysis' %}" class="analysis-form">
                    {% csrf_token %}
                    
                    <!-- Simple Form Row -->
                    <div class="row g-3 align-items-end mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Index</label>
                            <select name="instrument" class="form-select" onchange="loadExpiryDatesForInstrument(this.value)">
                                <option value="NIFTY" {% if instrument == 'NIFTY' %}selected{% endif %}>NIFTY</option>
                                <option value="BANKNIFTY" {% if instrument == 'BANKNIFTY' %}selected{% endif %}>BANKNIFTY</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Type</label>
                            <select name="calc_type" class="form-select">
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Expiry</label>
                            <select name="expiry" class="form-select">
                                {% for e in expiries %}<option value="{{ e }}">{{ e }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-play-fill me-1"></i>Generate
                            </button>
                        </div>
                    </div>

                    <div id="statusDisplay" class="mt-2"></div>
                </form>
            </div>
        </div>
        </div>
        
        <div id="analysis-results-container">
        {% if analysis_data %}
        <!-- Simple Results -->
        <div class="card border border-light bg-light mb-3">
            <div class="card-header bg-white border-light">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0 text-dark">Analysis Results - {{ analysis_data.instrument }} {{ analysis_data.expiry }}</h5>
                    </div>
                    {% if analysis_data.supply_zone and analysis_data.demand_zone %}
                    <div class="col-md-3">
                        <div class="card bg-primary-subtle border-primary border-2 rounded-3">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center justify-content-center">
                                    <h6 class="mb-0 fw-bold">
                                        <span class="badge bg-danger text-white me-2">Supply: ‚Çπ{{ analysis_data.supply_zone }}</span>
                                        <span class="badge bg-success text-white">Demand: ‚Çπ{{ analysis_data.demand_zone }}</span>
                                    </h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-6">
                        <!-- All Buttons in One Row -->
                        <div class="d-flex gap-1 justify-content-end flex-wrap">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="checkExpiryFetchErrors()" 
                                    title="Check expiry data status and errors" data-bs-toggle="tooltip">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearLocalStorage()" 
                                    title="Clear browser cache and stored data" data-bs-toggle="tooltip">
                                <i class="bi bi-trash"></i>
                            </button>
                            <a href="{% url 'add_trades' %}" class="btn btn-success btn-sm" 
                               title="Add analysis results to portfolio" data-bs-toggle="tooltip">
                                <i class="bi bi-plus-circle"></i>
                            </a>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearAnalysis()" 
                                    title="Clear current analysis and generate new" data-bs-toggle="tooltip">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                            <a href="{% url 'send_charts' %}" class="btn btn-info btn-sm" 
                               title="Send charts and analysis to Telegram" data-bs-toggle="tooltip">
                                <i class="bi bi-telegram"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body bg-light">
                <!-- Chart Tabs and Content in One Section -->
                <div class="row align-items-center mb-3">
                    <div class="col-md-6">
                        <ul class="nav nav-tabs border-0" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active btn-sm" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                                    <i class="bi bi-graph-up me-1"></i>Analysis
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-sm" id="payoff-tab" data-bs-toggle="tab" data-bs-target="#payoff" type="button" role="tab">
                                    <i class="bi bi-activity me-1"></i>Payoff
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-sm" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">
                                    <i class="bi bi-table me-1"></i>Data
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
                        
                        <script>
                        // Enhanced Expiry Loading with Local Storage Optimization
                        function loadExpiryDatesForInstrument(instrument) {
                            console.log(`üîÑ Loading expiry dates for ${instrument}...`);
                            
                            const expirySelect = document.querySelector('select[name="expiry"]');
                            if (!expirySelect) {
                                console.error('‚ùå Expiry select element not found');
                                return;
                            }
                            
                            // Check cache first
                            const cacheKey = `expiry_dates_${instrument}_cache`;
                            const cachedData = getCachedExpiries(cacheKey);
                            
                            if (cachedData && cachedData.length > 0) {
                                console.log(`‚úÖ Found cached expiry dates for ${instrument}:`, cachedData.length);
                                updateExpirySelect(expirySelect, cachedData);
                                return;
                            }
                            
                            // Show loading indicator
                            showExpiryLoadingIndicator(expirySelect);
                            
                            // Fetch fresh data with proper instrument parameter
                            const url = `{% url 'index' %}?instrument=${encodeURIComponent(instrument)}&ajax=1`;
                            
                            fetch(url, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                                    'Cache-Control': 'no-cache',
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                // Parse the response to extract expiry options
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const newExpirySelect = doc.querySelector('select[name="expiry"]');
                                
                                if (newExpirySelect && newExpirySelect.options.length > 0) {
                                    const expiries = Array.from(newExpirySelect.options)
                                        .filter(option => option.value && option.value.trim() !== '')
                                        .map(option => ({
                                            value: option.value.trim(),
                                            text: option.textContent.trim()
                                        }));
                                    
                                    if (expiries.length > 0) {
                                        // Cache the expiry dates
                                        cacheExpiries(cacheKey, expiries);
                                        
                                        // Update the select
                                        updateExpirySelect(expirySelect, expiries);
                                        
                                        console.log(`‚úÖ Loaded and cached ${expiries.length} expiry dates for ${instrument}`);
                                        
                                        // Update URL without page reload
                                        const url = new URL(window.location);
                                        url.searchParams.set('instrument', instrument);
                                        window.history.pushState({}, '', url);
                                    } else {
                                        throw new Error('No valid expiry dates found in response');
                                    }
                                } else {
                                    throw new Error('Could not find expiry select in response or it has no options');
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Error loading expiry dates:', error);
                                hideExpiryLoadingIndicator(expirySelect);
                                
                                // Try to show some fallback options
                                const fallbackExpiries = generateFallbackExpiries();
                                if (fallbackExpiries.length > 0) {
                                    updateExpirySelect(expirySelect, fallbackExpiries);
                                    console.log(`‚ö†Ô∏è Using fallback expiry dates for ${instrument}`);
                                } else {
                                    alert(`Error loading expiry dates for ${instrument}. Please try refreshing the page.`);
                                }
                            });
                        }
                        
                        function generateFallbackExpiries() {
                            const expiries = [];
                            const now = new Date();
                            
                            // Generate next 4 Thursdays as fallback
                            for (let i = 1; i <= 4; i++) {
                                const futureDate = new Date(now);
                                futureDate.setDate(now.getDate() + (i * 7));
                                
                                // Adjust to Thursday (4 = Thursday, 0 = Sunday)
                                const dayOfWeek = futureDate.getDay();
                                const daysToThursday = (4 - dayOfWeek + 7) % 7;
                                if (daysToThursday > 0) {
                                    futureDate.setDate(futureDate.getDate() + daysToThursday);
                                }
                                
                                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                                  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                const day = String(futureDate.getDate()).padStart(2, '0');
                                const month = monthNames[futureDate.getMonth()];
                                const year = futureDate.getFullYear();
                                const formattedDate = `${day}-${month}-${year}`;
                                
                                expiries.push({
                                    value: formattedDate,
                                    text: formattedDate
                                });
                            }
                            
                            return expiries;
                        }
                        
                        function getCachedExpiries(cacheKey) {
                            try {
                                const cached = localStorage.getItem(cacheKey);
                                if (cached) {
                                    const data = JSON.parse(cached);
                                    const now = Date.now();
                                    
                                    // Cache valid for 1 hour
                                    if (data.timestamp && (now - data.timestamp < 3600000)) {
                                        return data.expiries;
                                    } else {
                                        // Remove expired cache
                                        localStorage.removeItem(cacheKey);
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error reading expiry cache:', error);
                                localStorage.removeItem(cacheKey);
                            }
                            return null;
                        }
                        
                        function cacheExpiries(cacheKey, expiries) {
                            try {
                                const data = {
                                    expiries: expiries,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem(cacheKey, JSON.stringify(data));
                                console.log(`üíæ Cached ${expiries.length} expiry dates with key: ${cacheKey}`);
                            } catch (error) {
                                console.error('‚ùå Error caching expiry dates:', error);
                            }
                        }
                        
                        function updateExpirySelect(select, expiries) {
                            // Clear existing options
                            select.innerHTML = '';
                            
                            // Add new options
                            expiries.forEach(expiry => {
                                const option = document.createElement('option');
                                option.value = expiry.value;
                                option.textContent = expiry.text;
                                select.appendChild(option);
                            });
                            
                            hideExpiryLoadingIndicator(select);
                        }
                        
                        function showExpiryLoadingIndicator(select) {
                            select.innerHTML = '<option value="">üîÑ Loading expiry dates...</option>';
                            select.disabled = true;
                        }
                        
                        function hideExpiryLoadingIndicator(select) {
                            select.disabled = false;
                        }

                        function clearAnalysis() {
                            if (confirm('This will clear the current analysis. Continue?')) {
                                fetch('{% url "index" %}', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: 'clear_session=true'
                                }).then(() => {
                                    location.reload();
                                });
                            }
                        }
                        
                        function clearLocalStorage() {
                            if (confirm('This will clear all local storage data including expiry cache and settings. Continue?')) {
                                try {
                                    // Clear general cache items
                                    localStorage.removeItem('expiry_dates_cache');
                                    localStorage.removeItem('dashboard_refresh_rate');
                                    localStorage.removeItem('dashboard_refresh_interval');
                                    localStorage.removeItem('option_chain_cache');
                                    localStorage.removeItem('market_data_cache');
                                    
                                    // Clear instrument-specific expiry caches
                                    localStorage.removeItem('expiry_dates_NIFTY_cache');
                                    localStorage.removeItem('expiry_dates_BANKNIFTY_cache');
                                    
                                    // Clear any other potential instrument caches
                                    const keysToRemove = [];
                                    for (let i = 0; i < localStorage.length; i++) {
                                        const key = localStorage.key(i);
                                        if (key && key.startsWith('expiry_dates_') && key.endsWith('_cache')) {
                                            keysToRemove.push(key);
                                        }
                                    }
                                    keysToRemove.forEach(key => localStorage.removeItem(key));
                                    
                                    console.log('‚úÖ Local storage cleared successfully');
                                    alert('Local storage cleared! Page will reload.');
                                    location.reload();
                                } catch (error) {
                                    console.error('‚ùå Error clearing local storage:', error);
                                    alert('Error clearing local storage: ' + error.message);
                                }
                            }
                        }
                        
                        function checkExpiryFetchErrors() {
                            console.log('üîç Checking expiry date fetch status...');
                            
                            // Check current expiry data
                            const expirySelect = document.querySelector('select[name="expiry"]');
                            const instrumentSelect = document.querySelector('select[name="instrument"]');
                            const currentInstrument = instrumentSelect ? instrumentSelect.value : 'Unknown';
                            
                            if (expirySelect) {
                                const optionCount = expirySelect.options.length;
                                console.log(`üìÖ Current expiry options for ${currentInstrument}: ${optionCount}`);
                                
                                if (optionCount <= 1) {
                                    console.warn(`‚ö†Ô∏è Few or no expiry dates found for ${currentInstrument}`);
                                    alert(`‚ö†Ô∏è Warning: Only ${optionCount} expiry date(s) loaded for ${currentInstrument}.\nTry clearing cache and refreshing.`);
                                } else {
                                    console.log(`‚úÖ Expiry dates loaded successfully for ${currentInstrument}`);
                                    alert(`‚úÖ Status Check Complete\n${optionCount} expiry dates loaded for ${currentInstrument}\nSystem operating normally`);
                                }
                            } else {
                                console.error('‚ùå Expiry select element not found');
                                alert('‚ùå Error: Could not find expiry selection element');
                            }
                            
                            // Check cache status including instrument-specific caches
                            try {
                                const cacheKeys = [
                                    'expiry_dates_cache',
                                    'expiry_dates_NIFTY_cache',
                                    'expiry_dates_BANKNIFTY_cache',
                                    'dashboard_refresh_rate', 
                                    'dashboard_refresh_interval',
                                    'option_chain_cache',
                                    'market_data_cache'
                                ];
                                
                                let cacheStatus = 'Cache Status:\n';
                                cacheKeys.forEach(key => {
                                    const value = localStorage.getItem(key);
                                    if (key.includes('expiry_dates_') && key.endsWith('_cache') && value) {
                                        try {
                                            const data = JSON.parse(value);
                                            const age = data.timestamp ? Math.round((Date.now() - data.timestamp) / 60000) : 'Unknown';
                                            cacheStatus += `‚Ä¢ ${key}: ‚úì Present (${data.expiries?.length || 0} items, ${age}min old)\n`;
                                        } catch {
                                            cacheStatus += `‚Ä¢ ${key}: ‚úì Present (invalid format)\n`;
                                        }
                                    } else {
                                        cacheStatus += `‚Ä¢ ${key}: ${value ? '‚úì Present' : '‚úó Not found'}\n`;
                                    }
                                });
                                
                                console.log('üìã Cache Status:', cacheStatus);
                            } catch (error) {
                                console.error('‚ùå Error checking cache:', error);
                            }
                        }
                        
                        // Smart Data Fetching Status
                        function updateDataFetchMode() {
                            const fetchModeElement = document.getElementById('fetchModeText');
                            const badgeElement = document.getElementById('dataFetchMode');
                            
                            if (!fetchModeElement || !badgeElement) return;
                            
                            // Check if there are active background processes
                            // This is a simplified check - in reality, you'd query the server
                            const isOnDemand = !document.hidden; // Simple heuristic
                            
                            if (isOnDemand) {
                                fetchModeElement.textContent = 'On-Demand';
                                badgeElement.className = 'badge bg-success fs-6 px-3 py-2';
                                badgeElement.title = 'Data fetched only when needed - optimized performance';
                            } else {
                                fetchModeElement.textContent = 'Background';
                                badgeElement.className = 'badge bg-warning fs-6 px-3 py-2';
                                badgeElement.title = 'Background processes active';
                            }
                        }
                        
                        // Show loading indicator during data fetching
                        function showDataFetchIndicator(message = 'Fetching data...') {
                            const indicator = document.createElement('div');
                            indicator.id = 'dataFetchIndicator';
                            indicator.className = 'alert alert-info d-flex align-items-center mb-3';
                            indicator.innerHTML = `
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>${message}</span>
                            `;
                            
                            // Insert at top of page
                            const container = document.querySelector('.row');
                            if (container) {
                                container.insertBefore(indicator, container.firstChild);
                            }
                        }
                        
                        function hideDataFetchIndicator() {
                            const indicator = document.getElementById('dataFetchIndicator');
                            if (indicator) {
                                indicator.remove();
                            }
                        }
                        </script>
                <div class="tab-content" id="chartTabsContent">
                    <div class="tab-pane fade show active" id="summary" role="tabpanel">
                        {% if analysis_data.df_data %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Entry</th>
                                        <th>CE Strike</th>
                                        <th>CE Price</th>
                                        <th>PE Strike</th>
                                        <th>PE Price</th>
                                        <th>Target</th>
                                        <th>Stoploss</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in analysis_data.df_data %}
                                    <tr>
                                        <td>{{ entry.Entry }}</td>
                                        <td>{{ entry.CE_Strike }}</td>
                                        <td>‚Çπ{{ entry.CE_Price }}</td>
                                        <td>{{ entry.PE_Strike }}</td>
                                        <td>‚Çπ{{ entry.PE_Price }}</td>
                                        <td>‚Çπ{{ entry.Target }}</td>
                                        <td>‚Çπ{{ entry.Stoploss }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center">
                            <p class="text-muted">No strategies found for the selected analysis.</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="payoff" role="tabpanel">
                        <div class="text-center">
                            <img src="/{{ analysis_data.payoff_file }}" class="img-fluid rounded border">
                        </div>
                    </div>
                    <div class="tab-pane fade" id="table" role="tabpanel">
                        <div class="table-responsive">
                            {{ analysis_data.display_df_html|safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        </div>
        
        </div>
        
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.analysis-form');
    const resultsContainer = document.getElementById('analysis-results-container');
    const statusDisplay = document.getElementById('statusDisplay');

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (statusDisplay) {
                statusDisplay.innerHTML = '<div class="d-flex align-items-center gap-2"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div><span>Generating Analysis... Please wait.</span></div>';
            }
            
            const formData = new FormData(form);
            
            // Log form data for debugging
            for (var pair of formData.entries()) {
                console.log(pair[0]+ ', ' + pair[1]); 
            }

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                if (resultsContainer) {
                    // The response is the entire page, we need to extract the results part
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const newResults = doc.getElementById('analysis-results-container');
                    if (newResults) {
                        resultsContainer.innerHTML = newResults.innerHTML;
                    } else {
                        // If the container is not found, maybe the response is just the partial
                        resultsContainer.innerHTML = html;
                    }
                }
                if (statusDisplay) {
                    statusDisplay.innerHTML = '<span class="text-success">‚úì Analysis loaded.</span>';
                }
                // Re-initialize tooltips for new content (guard if Bootstrap is available)
                try {
                    if (window.bootstrap && typeof bootstrap.Tooltip === 'function') {
                        const tooltipTriggerList = Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                        tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
                    } else {
                        console.warn('Bootstrap JS not available, skipping tooltip init.');
                    }
                } catch (e) {
                    console.warn('Tooltip init failed:', e);
                }
            })
            .catch(error => {
                console.error('Error fetching analysis:', error);
                if (statusDisplay) {
                    statusDisplay.innerHTML = `<span class="text-danger">‚úó Error: ${error.message}. See console for details.</span>`;
                }
            });
        });
    }

    // Moved here: initial setup that was previously in the mid-page script
    updateDataFetchMode();
    const instrumentSelect = document.querySelector('select[name="instrument"]');
    if (instrumentSelect) {
        loadExpiryDatesForInstrument(instrumentSelect.value);
    }
});
</script>
{% endblock %}