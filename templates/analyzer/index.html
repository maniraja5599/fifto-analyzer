{% extends "analyzer/layout.html" %}
{% block content %}
    <div class="card">
        <div class="card-header"><h3>Generate New Analysis</h3></div>
        <div class="card-body">
            <form method="POST" action="{% url 'generate_analysis' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="instrument">Select Index</label>
                        <select id="instrument" name="instrument" class="form-control" onchange="window.location.href = `{% url 'index' %}?instrument=${this.value}`">
                            <option value="NIFTY" {% if instrument == 'NIFTY' %}selected{% endif %}>NIFTY</option>
                            <option value="BANKNIFTY" {% if instrument == 'BANKNIFTY' %}selected{% endif %}>BANKNIFTY</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="calc_type">Calculation Type</label>
                        <select id="calc_type" name="calc_type" class="form-control">
                            <option value="Weekly">Weekly</option>
                            <option value="Monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="expiry">Expiry Date</label>
                        <select id="expiry" name="expiry" class="form-control">
                            {% for e in expiries %}<option value="{{ e }}">{{ e }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Generate Charts</button>
            </form>
        </div>
    </div>

    {% if analysis_data %}
    <div class="card mt-4">
        <div class="card-header"><h4>Analysis Result</h4></div>
        <div class="card-body">
            <div class="mb-3">
                <a href="{% url 'add_trades' %}" class="btn btn-success">Add to Analysis</a>
                <a href="{% url 'send_charts' %}" class="btn btn-info">Send to Telegram</a>
            </div>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#summary">Analysis Chart</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#payoff">Payoff Chart</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#table">Data Table</a></li>
            </ul>
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="summary"><img src="/{{ analysis_data.summary_file }}" class="img-fluid"></div>
                <div class="tab-pane fade" id="payoff"><img src="/{{ analysis_data.payoff_file }}" class="img-fluid"></div>
                <div class="tab-pane fade" id="table">{{ analysis_data.display_df_html|safe }}</div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}